<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת סידור עבודה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kDXOkubaG5er1LmkB5QPA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
        }

        .schedule-table th,
        .schedule-table td {
            min-width: 120px;
            text-align: center;
            position: relative;
            vertical-align: top;
            padding-top: 8px;
            padding-bottom: 8px;
        }
        
        .unassigned {
            background-color: #fecaca; /* red-200 */
            color: #991b1b; /* red-800 */
        }

        .unavailable-slot {
            background-color: #e5e7eb;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #d1d5db 10px, #d1d5db 20px);
            cursor: not-allowed;
        }

        .slot-toggle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .schedule-table td:hover .slot-toggle {
            opacity: 1;
        }

        .employee-pill {
            cursor: grab;
            background-color: #e0e7ff; /* indigo-100 */
            color: #3730a3; /* indigo-800 */
            padding: 2px 8px;
            border-radius: 9999px;
            margin: 2px;
            display: inline-block;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid #c7d2fe;
        }

        .employee-pill:active {
            cursor: grabbing;
        }

        .drop-target-hover {
            background-color: #dbeafe !important; /* blue-200 */
            outline: 2px dashed #3b82f6; /* blue-500 */
        }

        /* Draggable employees in the list */
        .draggable-employee-source {
            cursor: grab;
            transition: background-color: 0.2s;
        }
        .draggable-employee-source:hover {
            background-color: #f0f9ff; /* sky-50 */
        }
        .draggable-employee-source:active {
            cursor: grabbing;
        }
        .dragging {
            opacity: 0.5;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-700">מערכת ניהול סידור עבודה</h1>
            <p class="text-gray-500 mt-2">ניהול עובדים, חנויות וסידורים בקלות וביעילות.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Settings & Employees Column -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Stores Management -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">ניהול חנויות</h2>
                    <div id="stores-list" class="space-y-2 mb-4"></div>
                    <div class="flex gap-2">
                        <input type="text" id="new-store-name" placeholder="שם חנות חדשה"
                            class="flex-grow p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                        <button id="add-store-btn"
                            class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">הוסף</button>
                    </div>
                </div>

                <!-- Employees Management -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">ניהול עובדים</h2>
                    <div id="employees-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        <!-- Employee cards will be injected here -->
                    </div>
                    <button id="add-employee-modal-btn"
                        class="mt-4 w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                        הוספת עובד/ת חדש/ה
                    </button>
                </div>
            </div>

            <!-- Schedule Column -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-semibold">סידור עבודה שבועי</h2>
                            <input type="date" id="week-start-date" class="p-2 border rounded-md bg-gray-50">
                        </div>
                        <div class="flex gap-2">
                             <button id="generate-schedule-btn"
                                class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 font-semibold transition shadow-lg">
                                הפק סידור אוטומטי
                            </button>
                            <button id="download-schedule-btn"
                                class="bg-teal-500 text-white px-6 py-2 rounded-md hover:bg-teal-600 font-semibold transition shadow-lg">
                                הורד כתמונה
                            </button>
                        </div>
                    </div>
                    <div id="schedule-container" class="overflow-x-auto">
                        <table id="schedule-table" class="w-full border-collapse schedule-table">
                            <!-- Schedule will be rendered here -->
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Employee Modal -->
    <div id="employee-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg transform transition-all scale-95 opacity-0"
            id="employee-modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-6">הוספת עובד/ת</h3>
            <form id="employee-form">
                <input type="hidden" id="employee-id">
                <div class="space-y-4">
                    <!-- Name & Rating -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="employee-name" class="block text-sm font-medium text-gray-700">שם מלא</label>
                            <input type="text" id="employee-name"
                                class="mt-1 block w-full p-2 border rounded-md" required>
                        </div>
                        <div>
                            <label for="employee-rating" class="block text-sm font-medium text-gray-700">דירוג (1-5)</label>
                            <input type="number" id="employee-rating" min="1" max="5" value="3"
                                class="mt-1 block w-full p-2 border rounded-md" required>
                        </div>
                    </div>

                     <!-- Preferred Store -->
                    <div>
                        <label for="employee-preferred-store" class="block text-sm font-medium text-gray-700">חנות
                            מועדפת</label>
                        <select id="employee-preferred-store" class="mt-1 block w-full p-2 border rounded-md">
                            <option value="any">אין העדפה</option>
                        </select>
                    </div>

                    <!-- Rules -->
                    <fieldset class="border p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2">כללים ואילוצים</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                             <div>
                                <label for="max-shifts" class="block text-sm font-medium text-gray-700">מקסימום
                                    משמרות בשבוע</label>
                                <input type="number" id="max-shifts" min="1" max="7" value="4"
                                    class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="max-weekends" class="block text-sm font-medium text-gray-700">מקסימום
                                    סופ"שים בחודש (מוערך)</label>
                                <input type="number" id="max-weekends" min="0" max="4" value="2"
                                    class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="no-evenings" class="h-4 w-4 rounded">
                                <label for="no-evenings" class="ml-2 block text-sm text-gray-900">לא עובד/ת ערב</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="no-doubles" class="h-4 w-4 rounded">
                                <label for="no-doubles" class="ml-2 block text-sm text-gray-900">ללא משמרות כפולות</label>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Days Off -->
                     <fieldset class="border p-4 rounded-md">
                        <legend class="text-lg font-semibold px-2">ימים קבועים לא זמינ/ה</legend>
                        <div id="days-off-container" class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-2">
                            <!-- Day checkboxes will be injected here -->
                        </div>
                    </fieldset>
                </div>
                <!-- Actions -->
                <div class="mt-8 flex justify-end gap-3">
                    <button type="button" id="cancel-employee-btn"
                        class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">ביטול</button>
                    <button type="submit" id="save-employee-btn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">שמור</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let stores = [
                { id: 'store_1', name: 'נמל' },
                { id: 'store_2', name: 'דיזינגוף' }
            ];
            let employees = [
                 {
                    id: 'emp_1', name: 'ישראל ישראלי', rating: 5, preferredStore: 'store_1',
                    rules: { maxShifts: 4, maxWeekends: 1, noEvenings: false, noDoubles: true, daysOff: ['ראשון'] }
                },
                {
                    id: 'emp_2', name: 'משה כהן', rating: 4, preferredStore: 'store_2',
                    rules: { maxShifts: 5, maxWeekends: 2, noEvenings: true, noDoubles: true, daysOff: [] }
                },
                {
                    id: 'emp_3', name: 'דנה לוי', rating: 4, preferredStore: 'any',
                    rules: { maxShifts: 3, maxWeekends: 1, noEvenings: false, noDoubles: false, daysOff: ['רביעי', 'חמישי'] }
                }
            ];
            let unavailableShifts = new Set(); // e.g., "ראשון-store_1-בוקר"
            let schedule = {}; // This will hold the generated schedule data

            const daysOfWeek = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
            const shifts = ['בוקר', 'ערב'];

            // --- LOCAL STORAGE FUNCTIONS ---
            function saveStateToLocalStorage() {
                localStorage.setItem('scheduler_stores', JSON.stringify(stores));
                localStorage.setItem('scheduler_employees', JSON.stringify(employees));
                localStorage.setItem('scheduler_unavailableShifts', JSON.stringify(Array.from(unavailableShifts)));
            }

            function loadStateFromLocalStorage() {
                const savedStores = localStorage.getItem('scheduler_stores');
                if (savedStores) {
                    stores = JSON.parse(savedStores);
                }

                const savedEmployees = localStorage.getItem('scheduler_employees');
                if (savedEmployees) {
                    employees = JSON.parse(savedEmployees);
                }

                const savedUnavailableShifts = localStorage.getItem('scheduler_unavailableShifts');
                if (savedUnavailableShifts) {
                    unavailableShifts = new Set(JSON.parse(savedUnavailableShifts));
                }
            }


            // --- DOM ELEMENTS ---
            const weekStartDateInput = document.getElementById('week-start-date');
            const storesList = document.getElementById('stores-list');
            const addStoreBtn = document.getElementById('add-store-btn');
            const newStoreNameInput = document.getElementById('new-store-name');
            const employeesList = document.getElementById('employees-list');
            const addEmployeeModalBtn = document.getElementById('add-employee-modal-btn');
            const employeeModal = document.getElementById('employee-modal');
            const employeeModalContent = document.getElementById('employee-modal-content');
            const employeeForm = document.getElementById('employee-form');
            const cancelEmployeeBtn = document.getElementById('cancel-employee-btn');
            const generateScheduleBtn = document.getElementById('generate-schedule-btn');
            const downloadScheduleBtn = document.getElementById('download-schedule-btn');
            const scheduleTable = document.getElementById('schedule-table');
            const preferredStoreSelect = document.getElementById('employee-preferred-store');

            // --- INITIALIZATION ---
            function init() {
                loadStateFromLocalStorage();
                setInitialDate();
                renderStores();
                renderEmployees();
                initializeSchedule();
                renderScheduleTableShell();
                renderDates();
                setupEventListeners();
                populatePreferredStoreSelect();
                populateDaysOff();
            }

            function setInitialDate() {
                const today = new Date();
                const dayOfWeek = today.getDay(); // Sunday = 0, Saturday = 6
                const lastSunday = new Date(today.setDate(today.getDate() - dayOfWeek));
                weekStartDateInput.value = lastSunday.toISOString().split('T')[0];
            }
            
            function initializeSchedule() {
                 daysOfWeek.forEach(day => {
                    schedule[day] = {};
                    stores.forEach(store => {
                        schedule[day][store.id] = {};
                        shifts.forEach(shift => {
                            schedule[day][store.id][shift] = [];
                        });
                    });
                });
            }

            // --- RENDER FUNCTIONS ---
            function renderStores() {
                storesList.innerHTML = stores.map(store => `
                    <div class="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                        <span>${store.name}</span>
                        <button data-id="${store.id}" class="delete-store-btn text-red-500 hover:text-red-700">מחק</button>
                    </div>
                `).join('');
            }

            function renderEmployees() {
                employeesList.innerHTML = employees.map(emp => `
                    <div class="p-4 border rounded-lg bg-gray-50 shadow-sm draggable-employee-source" draggable="true" data-employee-json='${JSON.stringify(emp)}'>
                        <div class="flex justify-between items-start pointer-events-none">
                            <div>
                                <p class="font-bold text-lg">${emp.name}</p>
                                <p class="text-sm text-gray-600">דירוג: ${'⭐'.repeat(emp.rating)}</p>
                                <p class="text-sm text-gray-500">חנות מועדפת: ${stores.find(s => s.id === emp.preferredStore)?.name || 'אין העדפה'}</p>
                            </div>
                            <div class="flex gap-2 pointer-events-auto">
                                <button data-id="${emp.id}" class="edit-employee-btn text-blue-500 hover:text-blue-700">ערוך</button>
                                <button data-id="${emp.id}" class="delete-employee-btn text-red-500 hover:text-red-700">מחק</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            function renderScheduleTableShell() {
                let thead = `<thead><tr class="bg-gray-200">
                    <th class="p-2 border">יום</th>
                    <th class="p-2 border">משמרת</th>
                    ${stores.map(s => `<th class="p-2 border">${s.name}</th>`).join('')}
                </tr></thead>`;

                let tbody = `<tbody>`;
                daysOfWeek.forEach((day, dayIndex) => {
                    shifts.forEach((shift, shiftIndex) => {
                        const isWeekend = day === 'שישי' || day === 'שבת';
                        const rowClass = isWeekend ? 'bg-yellow-50' : '';
                        tbody += `<tr class="${rowClass}">`;
                        if (shiftIndex === 0) {
                            tbody += `<td class="p-2 border font-semibold align-middle" rowspan="2">
                                ${day}
                                <br>
                                <span class="text-sm font-normal text-gray-500" data-date-for-day="${dayIndex}"></span>
                            </td>`;
                        }
                        tbody += `<td class="p-2 border font-semibold ${shift === 'בוקר' ? 'bg-blue-50' : 'bg-indigo-50'}">${shift}</td>`;
                        stores.forEach(store => {
                            const slotId = `${day}-${store.id}-${shift}`;
                            const isUnavailable = unavailableShifts.has(slotId);
                            const employeesInSlot = schedule[day]?.[store.id]?.[shift] || [];
                            
                            let cellContent = '';
                            if (employeesInSlot.length > 0) {
                                cellContent = employeesInSlot.map(emp => `
                                    <div class="employee-pill" draggable="true" data-employee-json='${JSON.stringify(emp)}' data-source-slot-id="${slotId}">
                                        ${emp.name.split(' ')[0]}
                                    </div>
                                `).join('');
                            } else if (employeesInSlot.isUnassigned) {
                                cellContent = '<span class="text-red-700 font-semibold">לא שובץ</span>';
                            }
                            
                            const cellClass = isUnavailable ? 'unavailable-slot' : 'bg-white';
                            const toggleTitle = isUnavailable ? 'הפוך משמרת לזמינה' : 'הפוך משמרת ללא זמינה';
                            
                            tbody += `<td class="p-2 border relative ${cellClass}" data-slot-id="${slotId}">
                                <div class="flex flex-wrap justify-center items-center min-h-[32px]">${cellContent}</div>
                                <div class="slot-toggle" title="${toggleTitle}">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001a.75.75 0 0 1 .75.75c0 .414-.336.75-.75.75h-4.992a.75.75 0 0 1-.75-.75c0-.414.336-.75.75-.75Z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.348h4.992v-.001a.75.75 0 0 1 .75.75c0 .414-.336.75-.75.75H3.75a.75.75 0 0 1-.75-.75c0-.414.336-.75.75-.75Zm0-3.248h4.992V6a.75.75 0 0 1 .75-.75c0-.414-.336-.75-.75-.75H3.75a.75.75 0 0 1-.75-.75c0-.414.336-.75.75-.75Zm0 6.496h4.992v.001a.75.75 0 0 1 .75.75c0 .414-.336.75-.75.75H3.75a.75.75 0 0 1-.75-.75c0-.414.336-.75.75-.75Zm12.273-3.248v.001a.75.75 0 0 1 .75.75c0 .414-.336.75-.75.75h-4.992a.75.75 0 0 1-.75-.75c0-.414.336-.75.75-.75h4.992ZM16.023 12.75h4.992v.001a.75.75 0 0 1 .75.75c0 .414-.336.75-.75.75h-4.992a.75.75 0 0 1-.75-.75c0-.414.336-.75.75-.75Zm0 3.248h4.992v-.001a.75.75 0 0 1 .75.75c0 .414-.336.75-.75.75h-4.992a.75.75 0 0 1-.75-.75c0-.414.336-.75.75-.75Z" />
                                    </svg>
                                </div>
                            </td>`;
                        });
                        tbody += `</tr>`;
                    });
                });
                tbody += `</tbody>`;

                scheduleTable.innerHTML = thead + tbody;
                renderDates();
            }

            function renderDates() {
                const startDate = new Date(weekStartDateInput.value + 'T00:00:00'); // Ensure local time
                for(let i=0; i<7; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    const day = currentDate.getDate().toString().padStart(2, '0');
                    const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                    const dateSpan = document.querySelector(`[data-date-for-day="${i}"]`);
                    if(dateSpan) {
                        dateSpan.textContent = `${day}/${month}`;
                    }
                }
            }

            function populatePreferredStoreSelect() {
                preferredStoreSelect.innerHTML = `<option value="any">אין העדפה</option>`;
                stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.id;
                    option.textContent = store.name;
                    preferredStoreSelect.appendChild(option);
                });
            }
             function populateDaysOff() {
                const container = document.getElementById('days-off-container');
                container.innerHTML = daysOfWeek.map(day => `
                    <div class="flex items-center">
                        <input type="checkbox" id="day-off-${day}" data-day="${day}" class="h-4 w-4 rounded day-off-checkbox">
                        <label for="day-off-${day}" class="ml-2 block text-sm text-gray-900">${day}</label>
                    </div>
                `).join('');
            }
            
            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                weekStartDateInput.addEventListener('change', renderDates);
                addStoreBtn.addEventListener('click', handleAddStore);
                storesList.addEventListener('click', handleDeleteStore);
                addEmployeeModalBtn.addEventListener('click', () => openEmployeeModal());
                cancelEmployeeBtn.addEventListener('click', closeEmployeeModal);
                employeeModal.addEventListener('click', (e) => { if (e.target.id === 'employee-modal') closeEmployeeModal(); });
                employeeForm.addEventListener('submit', handleSaveEmployee);
                employeesList.addEventListener('click', handleEmployeeActions);
                generateScheduleBtn.addEventListener('click', handleGenerateSchedule);
                downloadScheduleBtn.addEventListener('click', handleDownloadSchedule);

                scheduleTable.addEventListener('click', (e) => {
                    const toggle = e.target.closest('.slot-toggle');
                    if (toggle) {
                        const cell = toggle.closest('td');
                        if (cell) handleToggleSlot(cell.dataset.slotId, cell);
                    }
                });

                // Drag and Drop Listeners
                document.addEventListener('dragstart', handleDragStart);
                scheduleTable.addEventListener('dragover', handleDragOver);
                scheduleTable.addEventListener('dragleave', handleDragLeave);
                scheduleTable.addEventListener('drop', handleDrop);
                document.addEventListener('dragend', () => {
                    document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                });
            }
            
            // --- HANDLERS ---
            function handleAddStore() {
                const name = newStoreNameInput.value.trim();
                if (name) {
                    stores.push({ id: `store_${Date.now()}`, name });
                    newStoreNameInput.value = '';
                    saveStateToLocalStorage();
                    renderStores();
                    initializeSchedule();
                    renderScheduleTableShell();
                    populatePreferredStoreSelect();
                }
            }

            function handleDeleteStore(e) {
                if (e.target.classList.contains('delete-store-btn')) {
                    const storeId = e.target.dataset.id;
                    stores = stores.filter(s => s.id !== storeId);
                    saveStateToLocalStorage();
                    renderStores();
                    initializeSchedule();
                    renderScheduleTableShell();
                    populatePreferredStoreSelect();
                }
            }

            function openEmployeeModal(employeeToEdit = null) {
                employeeForm.reset();
                document.getElementById('employee-id').value = '';
                const modalTitle = document.getElementById('modal-title');
                document.querySelectorAll('.day-off-checkbox').forEach(cb => cb.checked = false);

                if (employeeToEdit) {
                    modalTitle.textContent = 'עריכת עובד/ת';
                    document.getElementById('employee-id').value = employeeToEdit.id;
                    document.getElementById('employee-name').value = employeeToEdit.name;
                    document.getElementById('employee-rating').value = employeeToEdit.rating;
                    document.getElementById('employee-preferred-store').value = employeeToEdit.preferredStore;
                    document.getElementById('max-shifts').value = employeeToEdit.rules.maxShifts;
                    document.getElementById('max-weekends').value = employeeToEdit.rules.maxWeekends;
                    document.getElementById('no-evenings').checked = employeeToEdit.rules.noEvenings;
                    document.getElementById('no-doubles').checked = employeeToEdit.rules.noDoubles;
                    employeeToEdit.rules.daysOff.forEach(day => {
                        const checkbox = document.getElementById(`day-off-${day}`);
                        if(checkbox) checkbox.checked = true;
                    });
                } else {
                    modalTitle.textContent = 'הוספת עובד/ת';
                }

                employeeModal.classList.remove('hidden');
                employeeModal.classList.add('flex');
                setTimeout(() => employeeModalContent.classList.remove('scale-95', 'opacity-0'), 10);
            }

            function closeEmployeeModal() {
                employeeModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    employeeModal.classList.add('hidden');
                    employeeModal.classList.remove('flex');
                }, 200);
            }

            function handleSaveEmployee(e) {
                e.preventDefault();
                const id = document.getElementById('employee-id').value;
                const daysOff = Array.from(document.querySelectorAll('.day-off-checkbox:checked')).map(cb => cb.dataset.day);

                const employeeData = {
                    id: id || `emp_${Date.now()}`,
                    name: document.getElementById('employee-name').value,
                    rating: parseInt(document.getElementById('employee-rating').value),
                    preferredStore: document.getElementById('employee-preferred-store').value,
                    rules: {
                        maxShifts: parseInt(document.getElementById('max-shifts').value),
                        maxWeekends: parseInt(document.getElementById('max-weekends').value),
                        noEvenings: document.getElementById('no-evenings').checked,
                        noDoubles: document.getElementById('no-doubles').checked,
                        daysOff: daysOff
                    }
                };

                if (id) {
                    const index = employees.findIndex(emp => emp.id === id);
                    if (index > -1) employees[index] = employeeData;
                } else {
                    employees.push(employeeData);
                }
                
                saveStateToLocalStorage();
                renderEmployees();
                closeEmployeeModal();
            }

            function handleEmployeeActions(e) {
                const id = e.target.dataset.id;
                if (!id) return;
                if (e.target.classList.contains('edit-employee-btn')) {
                    openEmployeeModal(employees.find(emp => emp.id === id));
                }
                if (e.target.classList.contains('delete-employee-btn')) {
                    if (confirm('האם אתה בטוח שברצונך למחוק עובד/ת זה?')) {
                        employees = employees.filter(emp => emp.id !== id);
                        saveStateToLocalStorage();
                        renderEmployees();
                    }
                }
            }

            function handleDownloadSchedule() {
                 const table = document.getElementById('schedule-table');
                 const originalBg = table.style.backgroundColor;
                 table.style.backgroundColor = 'white';
                html2canvas(table).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'schedule.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    table.style.backgroundColor = originalBg;
                });
            }

            function handleToggleSlot(slotId, cell) {
                if (unavailableShifts.has(slotId)) {
                    unavailableShifts.delete(slotId);
                } else {
                    unavailableShifts.add(slotId);
                    const [day, storeId, shift] = slotId.split('-');
                    schedule[day][storeId][shift] = [];
                }
                saveStateToLocalStorage();
                renderScheduleTableShell();
            }
            
            // --- DRAG & DROP HANDLERS ---
            function handleDragStart(e) {
                const target = e.target;
                if (target.matches('.draggable-employee-source, .employee-pill')) {
                    const employeeJson = target.dataset.employeeJson;
                    const sourceSlotId = target.dataset.sourceSlotId;
                    const payload = {
                        employee: JSON.parse(employeeJson),
                        sourceSlotId: sourceSlotId
                    };
                    e.dataTransfer.setData('application/json', JSON.stringify(payload));
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => target.classList.add('dragging'), 0);
                }
            }

            function handleDragOver(e) {
                e.preventDefault();
                const targetCell = e.target.closest('td[data-slot-id]');
                if (targetCell && !unavailableShifts.has(targetCell.dataset.slotId)) {
                    targetCell.classList.add('drop-target-hover');
                }
            }

            function handleDragLeave(e) {
                const targetCell = e.target.closest('td[data-slot-id]');
                if (targetCell) {
                    targetCell.classList.remove('drop-target-hover');
                }
            }
            
            function handleDrop(e) {
                e.preventDefault();
                const targetCell = e.target.closest('td[data-slot-id]');
                if (!targetCell || unavailableShifts.has(targetCell.dataset.slotId)) return;
                
                targetCell.classList.remove('drop-target-hover');
                
                const payload = JSON.parse(e.dataTransfer.getData('application/json'));
                const employee = payload.employee;
                const sourceSlotId = payload.sourceSlotId;
                const targetSlotId = targetCell.dataset.slotId;

                const [tDay, tStoreId, tShift] = targetSlotId.split('-');
                
                // --- Double Booking Prevention ---
                const isAlreadyWorkingSameTime = stores.some(store => {
                    // Check if employee is in another store at the same day and shift
                    return schedule[tDay][store.id][tShift].some(emp => emp.id === employee.id);
                });

                const [sDay, , sShift] = sourceSlotId ? sourceSlotId.split('-') : [null, null, null];
                const isMoveInSameTimeSlot = (tDay === sDay && tShift === sShift);

                if(isAlreadyWorkingSameTime && !isMoveInSameTimeSlot) {
                    console.warn(`Cannot schedule ${employee.name}. Already working at this time.`);
                    return; // Abort drop
                }
                // --- End of Prevention ---

                // Remove from source if it's a move from another slot
                if (sourceSlotId) {
                    const [sDay, sStoreId, sShift] = sourceSlotId.split('-');
                    schedule[sDay][sStoreId][sShift] = schedule[sDay][sStoreId][sShift].filter(emp => emp.id !== employee.id);
                }

                // Add to target if not already there
                const targetArray = schedule[tDay][tStoreId][tShift];
                if (!targetArray.some(emp => emp.id === employee.id)) {
                    targetArray.push(employee);
                }
                
                renderScheduleTableShell();
            }

            // --- SCHEDULING ALGORITHM ---
            function handleGenerateSchedule() {
                initializeSchedule();
                let employeeStats = {};
                employees.forEach(emp => {
                    employeeStats[emp.id] = { shifts: 0, weekends: 0 };
                });
                
                const slotsToFill = [];
                daysOfWeek.forEach(day => {
                    stores.forEach(store => {
                        shifts.forEach(shift => {
                            const slotId = `${day}-${store.id}-${shift}`;
                            if (!unavailableShifts.has(slotId)) {
                                slotsToFill.push({ day, storeId: store.id, shift });
                            }
                        });
                    });
                });

                slotsToFill.forEach(slot => {
                    const availableEmployees = findAvailableEmployees(slot, schedule, employeeStats);
                    
                    if (availableEmployees.length > 0) {
                        availableEmployees.sort((a, b) => {
                            if (b.rating !== a.rating) return b.rating - a.rating;
                            const aPrefers = a.preferredStore === slot.storeId;
                            const bPrefers = b.preferredStore === slot.storeId;
                            if (aPrefers !== bPrefers) return bPrefers ? 1 : -1;
                            if (employeeStats[a.id].shifts !== employeeStats[b.id].shifts) {
                                return employeeStats[a.id].shifts - employeeStats[b.id].shifts;
                            }
                            return 0;
                        });

                        const chosenEmployee = availableEmployees[0];
                        schedule[slot.day][slot.storeId][slot.shift].push({id: chosenEmployee.id, name: chosenEmployee.name});
                        employeeStats[chosenEmployee.id].shifts++;
                        if (slot.day === 'שישי' || slot.day === 'שבת') {
                            employeeStats[chosenEmployee.id].weekends += 0.5;
                        }

                    } else {
                        schedule[slot.day][slot.storeId][slot.shift].isUnassigned = true;
                    }
                });

                renderScheduleTableShell();
            }

            function findAvailableEmployees(slot, currentSchedule, stats) {
                return employees.filter(emp => {
                    if (stats[emp.id].shifts >= emp.rules.maxShifts) return false;
                    if (emp.rules.noEvenings && slot.shift === 'ערב') return false;
                    if (emp.rules.daysOff.includes(slot.day)) return false;
                    
                    if (emp.rules.noDoubles) {
                        const otherShift = slot.shift === 'בוקר' ? 'ערב' : 'בוקר';
                        for (const store of stores) {
                            if (currentSchedule[slot.day][store.id][otherShift].some(e => e.id === emp.id)) return false;
                        }
                    }
                    const isWeekend = slot.day === 'שישי' || slot.day === 'שבת';
                    if (isWeekend && (stats[emp.id].weekends + 0.5 > emp.rules.maxWeekends)) return false;
                    // Prevents double booking in the same shift across different stores
                    for (const store of stores) {
                        if (currentSchedule[slot.day][store.id][slot.shift].some(e => e.id === emp.id)) return false;
                    }
                    
                    return true;
                });
            }

            // --- START THE APP ---
            init();
        });
    </script>
</body>

</html>

